<!DOCTYPE html>
<html>

<head>
    <title>pbcsf</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" type="text/css" href="./fullpage/fullpage.css" />
    <link rel="stylesheet" href="./style/common.css">
    <link href="./images/logo.svg" rel="shortcut icon">
    <!--[if IE]>
    <script type="text/javascript">
        var console = { log: function() {} };
    </script>
    <![endif]-->
</head>
<body>
<div id="fullpage">
    <div class="section">
        <!--first-->
        <div id="id_first" class="first-body body"></div>
    </div>
    <div class="section">
        <!--second-->
        <div id="id_second" class="second-body body"></div>
    </div>
    <div class="section">
        <!--fifth-->
        <div id="id_fifth" class="fifth-body body"></div>
    </div>
</div>
<div id="recommend_card"></div>
<!--third-->
<div id="id_third" class="third-body"></div>
<!-- message -->
<div id="MessageModal" class="warning"></div>

<!-- 海报展示图 -->
<div class="show-photo-box">
    <span class="show-photo-box-close" id="handleClosePhotoBox">+</span>
    <div class="show-photo-box-img">
        <img src="" alt="" id="show-photo-box-img-url">
        <div>
            <span>请长按保存图片</span>
        </div>
    </div>
</div>

<!-- 查看规则 -->
<div class="recommend-rule-content">
    <div class="recommend-rule-content-card">
        <div class="recommend-rule-content-card-title">规则标题</div>
        <div class="recommend-rule-content-card-des">规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则</div>
        <div class="recommend-rule-content-card-des">规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则</div>
        <div class="recommend-rule-content-card-des">规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则</div>
        <div class="recommend-rule-content-card-des">规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则</div>
        <div class="recommend-rule-content-card-des">规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则规则</div>
    </div>
</div>

<script src="js/html2canvas.min.js"></script>
<script src="./js/jquery.js"></script>
<script type="text/javascript" src="./fullpage/fullpage.js"></script>
<script src="./js/qrcode.js"></script>
<script src="js/flex.js"></script>

<!--<script src="https://list.wangyc.top/html2canvas.min.js"></script>-->
<script>
    const PFMP_URL = 'https://api.test.pbcsf.net'
    const PFMP_API = {
        captcha: PFMP_URL + '/admission/api/v1/account/mobile/captcha',
        check: PFMP_URL + '/admission/api/v2/application/class/check',
    }
    function message(t, str) {
      if (t === 'success') {
        ht = '<span class="success">√</span>' + str
      } else if (t === 'warning') {
        ht = '<span class="warning">!</span>' + str
      } else if (t === 'error') {
        ht = '<span class="error">x</span>' + str
      } else {
        ht = '<span class="info">i</span>' + str
      }
      $('#MessageModal').attr('class', t)
      $('#MessageModal').html(ht)
      $('#MessageModal').fadeIn(500)
      setTimeout(function() {
        $('#MessageModal').fadeOut(500)
      }, 2500)
    }
    function ValidateMobile(phone) {
      return !(!/^1[3456789]\d{9}$/.test(phone) || phone === '');
    }
    // 获取check接口信息
    function CheckFormFn() {
      const tel = $('#recommendFormMobile')[0].value
      const captcha = $('#recommendFormCaptcha')[0].value
      const name = $('#recommendFormName')[0].value
      if (!name) {
        message('warning', '请检查姓名是否填写')
        $('#recommendFormName').focus()
        return
      } else if (!ValidateMobile(tel)) {
        message('warning', '请检查手机号是否填写')
        $('#recommendFormMobile').focus()
        return
      } else if (!captcha) {
        message('warning', '请检查验证码是否填写')
        $('#recommendFormCaptcha').focus()
        return
      }
      const obj = {
        product_id: '5f8fc73b5c262aad45191379',
        name,
        mobile: tel,
        captcha
      }
      PFMP_API.check
      $.ajax({
        type: 'post',
        url: PFMP_API.check,
        data: JSON.stringify(obj),
        cache:false,
        contentType: 'application/json',
        success: function(res) {
          console.log(res)
          if (res.code === 200) {
            if (res.data.gender === '男性') {
              $('.third-user-docx .user-docx-enrollment').text(res.data.shortcut + '学长')
            } else {
              $('.third-user-docx .user-docx-enrollment').text(res.data.shortcut + '学姐')
            }
            $('.third-user-docx .user-docx-enrollment—name').text(obj.name || '姓名')
            $('.third-content-images2 .third-project-name').text(res.data.project)
            if (localStorage.getItem('PBCSF-PFMP-AVATAR')) {
              $('#createQRcode').html('')
              $('.third-user-avatar').attr('src', localStorage.getItem('PBCSF-PFMP-AVATAR'))
            }
            const url = window.location.origin + '/landing.html?name=' + obj.name + '&p_c=' + res.data.shortcut + '&g=' + res.data.gender + '&c=' + res.data.enrollment_no
            CreateQRcodeFn(url) // 生成分享卡片
          } else {
            message('warning', res.msg)
          }
        },
        error: function(err) {
          console.log(err)
        }
      })
    }
    //  关闭 信息填写 card
    function ToggleRecommendCard() {
        $(document).delegate('#handleMyRecommend, #handleRecommendClose', 'click', function () {
            console.log('===log')
            $('#recommend_card').toggle()
        })
        $(document).delegate('#handleCreatePoster', 'click', function () {
            CheckFormFn()
        })
        $(document).delegate('#handleClosePhotoBox', 'click', function () {
            $(".show-photo-box").toggle()
        })
    }
    // 生成二维码
    function CreateQRcodeFn(u) {
      console.log(u)
      var qrcode = new QRCode(document.getElementById("createQRcode"), {
        text: u,
        width: 65,
        height: 65,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
      });
      // 创建 海报
      CreateHtml2Canvas()
    }
    //  创建canvas
    function CreateHtml2Canvas() {
        const canvas_dom = $('#id_third')[0]
        html2canvas(canvas_dom, {
            backgroundColor: null,
            dpi: window.devicePixelRatio * 2,
            scale: 2,
            width: canvas_dom.offsetWidth,
            height: canvas_dom.offsetHeight,
            // height: 1334,
            scrollY: 0,
            scrollX: 0,
            useCORS: true,
            background: "white"
        }).then(canvas => {
            let url = canvas.toDataURL('image/png')
            localStorage.setItem('PBCSF-PFMP', url)
            $('#recommend_card').toggle() // 关闭 信息填写弹窗
            setTimeout(() => {
              $('#show-photo-box-img-url').attr('src', url) // 待展示分享图片链接赋值
              $(".show-photo-box").toggle() // 展示分享图片弹窗
            }, 500)
        }).catch(err => {
            console.log(err)
        })
    }
    // 获取验证码
    function GetCaptchaFn() {
      const tel = $('#recommendFormMobile')[0].value
      const obj = {
        'mobile': tel
      }
      $.ajax({
        type: 'post',
        url: PFMP_API.captcha,
        data: JSON.stringify(obj),
        cache:false,
        contentType: 'application/json',
        success: function(res) {
          console.log(res)
          if (res.code === 200) {
            message('success', res.msg)
          } else {
            message('warning', res.msg)
          }
        },
        error: function(err) {
          console.log(err)
        }
      })
      // $.post(PFMP_API.captcha, { 'mobile': tel },function(data,status){
      //   alert("Data: " + data + "nStatus: " + status);
      // });
    }
    // 验证码按钮
    function captchaTime() {
      console.log(']]]]]')
      $(document).delegate('#getCaptcha', 'click', function() {
        const tel = $('#recommendFormMobile')[0].value
        console.log(tel)
        if (!ValidateMobile(tel)) {
          message('warning', '手机号有误')
          $('#recommendFormMobile').focus()
          return
        }
        $(".get-captcha").hide()
        $(".get-captcha-count").show()
        GetCaptchaFn()
        var second = 60
        $(".get-captcha-count").text((second) + "s重新获取")
        var interval = setInterval(function () {
          second--
          $(".get-captcha-count").text((second) + "s重新获取")
          if (second === -1) {
            $(".get-captcha").text("重发验证码")
            clearInterval(interval)
            $(".get-captcha-count").hide()
            $(".get-captcha").show()
          }
        }, 1000)
      })
    }
    // 头像上传
    function UploadAvatar () {
      $(document).delegate('#UploadAvatarDom', 'change', function() {
        if (!this.files[0]) { return }
        if (this.files[0].size > (10*1024*1024)) {
          message('warning', '请上传小于10M的图片')
          return
        }
        const fileReader = new FileReader()
        fileReader.readAsDataURL(this.files[0])
        fileReader.onload = ()=>{
          avatarBase64 = fileReader.result
          localStorage.setItem('PBCSF-PFMP-AVATAR', avatarBase64)
          $('#avatarData').attr('src', avatarBase64).show()
        }
      })
    }

    // 展示推荐规则
    function ToggleRecommendRule () {
      $('#handleRecommendRule').on('click', function() {
        $('.recommend-rule-content').toggle()
      })
      $(document).delegate('#handleRecommendRule', 'click', function() {
        $('.recommend-rule-content').toggle()
      })
      $('.recommend-rule-content').on('click', function() {
        $('.recommend-rule-content').toggle()
      })
      $('.recommend-rule-content-card').on('click', function() {
        event.stopPropagation()
      })
    }

    $(document).ready(function(){
      $("#id_first").load("./pages/first.html",function(){
        console.log('======1======')
      });
      $("#id_second").load("./pages/second.html",function(){
        console.log('======2======')
      });
      $("#id_third").load("./pages/third.html",function(){
        console.log('======3======')
      });
      $("#id_fifth").load("./pages/fifth.html",function(){
        console.log('======5======')
      });
      $("#recommend_card").load("./pages/recommend-card.html",function(){
        console.log('======card======')
      });
      $('#recommendCardForm').on('click', function() {
        event.stopPropagation()
      })

      //initialising fullpage.js in the jQuery way
      $('#fullpage').fullpage({
        // sectionsColor: ['#ff5f45', '#0798ec', '#fc6c7c', '#fec401'],
        licenseKey: '999',
        navigation: true,
        slidesNavigation: true,
      });
      ToggleRecommendCard()
      captchaTime()
      UploadAvatar()
      ToggleRecommendRule()
    });
</script>
</body>
</html>
