<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>企业微信登录</title>
    <script src="https://fastly.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <style>
        .loading {
            width: 150px;
            height: 150px;
            left: 50%;
            top:30%;
            margin-left: -75px;
            position: fixed;
            display: flex;
            border-radius: 50%;
            overflow: hidden;
            -webkit-mask: radial-gradient(transparent 55%, #000 55%);
            animation: rotate 1s linear infinite;
        }
        .left {
            width: 50%;
            height: 100%;
            background: linear-gradient(rgb(2, 211, 248), rgba(2, 211, 248, .5))
        }
        .right {
            width: 50%;
            height: 100%;
            background: linear-gradient(rgba(0, 0, 0, 0), rgba(2, 211, 248, .5));
        }
        @keyframes rotate {
            0% {
                transform: rotateZ(0);
            }
            100% {
                transform: rotateZ(360deg);
            }
        }
            .body-box {
                position: fixed;
                width: 100%;
                left: 0;
                height: 100%;
                background: #ffffff;
                z-index: 999;
                top: 0;
                text-align: center;
                color: #333333;
                display: none;
            }
        .body-box {
            padding: 100px 0;
            font-size: 3em;
        }
        .debug-button {
            width: 100%;
            padding: 20px 0;
            background: #bb133e;
            color: #ffffff;
            font-size: 16px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="body-box">
        <?xml version="1.0" encoding="UTF-8" standalone="no"?>
        <svg
                xmlns:dc="http://purl.org/dc/elements/1.1/"
                xmlns:cc="http://creativecommons.org/ns#"
                xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
                xmlns:svg="http://www.w3.org/2000/svg"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 1133.8533 944.88"
                height="300"
                width="500"
                xml:space="preserve"
                id="svg2"
                version="1.1"><metadata
     id="metadata8"><rdf:RDF><cc:Work
         rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type
                rdf:resource="http://purl.org/dc/dcmitype/StillImage" /></cc:Work></rdf:RDF></metadata><defs
                id="defs6"><clipPath
       id="clipPath22"
       clipPathUnits="userSpaceOnUse"><path
         id="path20"
         d="M 0,708.66 H 850.39 V 0 H 0 Z" /></clipPath></defs><g
                transform="matrix(1.3333333,0,0,-1.3333333,0,944.88)"
                id="g10"><g
       transform="translate(358.3221,346.7648)"
       id="g12"><path
         id="path14"
         style="fill:#0079de;fill-opacity:1;fill-rule:nonzero;stroke:none"
         d="M 0,0 H 33.734 V 11.802 H 0 V 39.604 H -12.295 V -27.128 H -32.748 V 21.811 H -44.796 V -27.128 H -63.455 V -39.049 H 42.633 v 11.921 H 0 Z" /></g><g
                id="g16"><g
         clip-path="url(#clipPath22)"
         id="g18"><g
           transform="translate(353.0775,418.4563)"
           id="g24"><path
             id="path26"
             style="fill:#0079de;fill-opacity:1;fill-rule:nonzero;stroke:none"
             d="M 0,0 -0.487,0.537 H -8.371 L -8.858,-0.01 c -14.506,-16.228 -32.679,-29.863 -54.011,-40.526 l -1.52,-0.764 6.292,-11.428 1.422,0.749 c 21.407,11.308 38.985,24.912 52.267,40.452 14.53,-16.621 31.936,-30.188 51.756,-40.333 l 1.399,-0.719 6.452,11.415 -1.573,0.759 C 33.523,-30.659 15.48,-17.063 0,0" /></g><g
                transform="translate(495.8605,418.1299)"
                id="g28"><path
             id="path30"
             style="fill:#0079de;fill-opacity:1;fill-rule:nonzero;stroke:none"
             d="M 0,0 H -12.295 V -98.245 H -26.569 V 0 H -38.864 V -98.245 H -75.689 V -110.17 H 37.072 v 11.925 H 0 Z" /></g><g
                transform="translate(439.983,334.3255)"
                id="g32"><path
             id="path34"
             style="fill:#0079de;fill-opacity:1;fill-rule:nonzero;stroke:none"
             d="m 0,0 0.371,-1.645 11.34,2.921 -0.362,1.559 C 6.356,24.144 0.512,43.549 -6.02,60.51 l -0.559,1.452 -10.622,-3.482 0.578,-1.588 C -10.001,38.739 -4.408,19.597 0,0" /></g><g
                transform="translate(510.7834,334.6127)"
                id="g36"><path
             id="path38"
             style="fill:#0079de;fill-opacity:1;fill-rule:nonzero;stroke:none"
             d="m 0,0 c 7.49,16.082 13.805,35.192 18.77,56.796 l 0.352,1.522 -11.06,3.109 -0.387,-1.665 C 2.435,37.455 -3.844,18.78 -10.984,4.254 L -11.798,2.601 -0.627,-1.35 Z" /></g><g
                transform="translate(643.892,388.288)"
                id="g40"><path
             id="path42"
             style="fill:#0079de;fill-opacity:1;fill-rule:nonzero;stroke:none"
             d="m 0,0 c -0.399,-13.067 -1.909,-24.881 -4.498,-35.188 -2.503,8.215 -4.639,17.645 -6.361,28.089 0.471,1.753 0.893,3.554 1.37,5.587 L -9.133,0 Z m 1.727,-51.823 c 5.501,14.212 8.598,31.642 9.21,51.823 h 4.984 V 11.554 H -6.886 c 1.061,6.327 1.847,11.556 2.529,16.809 l 0.201,1.553 -11.052,1.933 -0.186,-1.745 c -2.057,-19.705 -5.653,-36.421 -10.698,-49.791 v 4.051 h -41.83 v -11.181 h 38.854 c -0.287,-0.625 -0.58,-1.241 -0.876,-1.849 l -0.453,-0.93 7.156,-8.943 1.16,2.216 c 1.845,3.501 3.533,7.099 5.124,10.925 2.085,-9.354 4.514,-17.854 7.24,-25.315 -4.282,-9.766 -10.157,-17.885 -17.471,-24.138 l -1.077,-0.92 6.487,-10.242 1.44,1.284 c 6.416,5.728 11.91,12.635 16.356,20.559 3.961,-8.125 8.676,-14.892 14.034,-20.135 l 1.406,-1.375 6.953,10.344 -1.051,0.952 c -5.976,5.389 -11.234,12.979 -15.633,22.561" /></g><g
                transform="translate(548.7776,377.32)"
                id="g44"><path
             id="path46"
             style="fill:#0079de;fill-opacity:1;fill-rule:nonzero;stroke:none"
             d="M 0,0 C 11.884,10.384 20.638,22.444 26.022,35.843 L 26.6,37.279 15.941,42.266 15.312,40.618 C 11.146,29.664 4.34,19.726 -4.916,11.077 l -0.749,-0.703 3.777,-12.019 z" /></g><g
                transform="translate(619.0348,412.6899)"
                id="g48"><path
             id="path50"
             style="fill:#0079de;fill-opacity:1;fill-rule:nonzero;stroke:none"
             d="m 0,0 h -10.565 v -21.377 h -5.378 V 6.675 h -10.81 V -21.377 H -32.13 V 0 H -42.817 V -32.312 H 0 Z" /></g><g
                transform="translate(575.8272,381.4801)"
                id="g52"><path
             id="path54"
             style="fill:#0079de;fill-opacity:1;fill-rule:nonzero;stroke:none"
             d="M 0,0 -10.395,5.028 -11.007,3.31 c -4.258,-11.919 -10.958,-22.225 -20.484,-31.509 l -0.717,-0.697 3.642,-11.953 1.911,1.741 c 3.099,2.816 5.86,5.583 8.385,8.4 v -48.247 h 11.552 v 64.22 c 2.335,4.021 4.422,8.509 6.2,13.34 z" /></g><g
                transform="translate(625.1353,327.1327)"
                id="g56"><path
             id="path58"
             style="fill:#0079de;fill-opacity:1;fill-rule:nonzero;stroke:none"
             d="M 0,0 0.614,0.649 -2.144,11.873 -4.199,9.823 C -6.722,7.298 -9.34,4.797 -12.156,2.218 v 25.629 h -32.56 V 12.635 C -44.835,0.528 -48.044,-8.82 -54.256,-15.15 l -1.221,-1.24 9.026,-7.834 1.076,1.096 c 7.85,7.974 11.959,19.996 12.211,35.747 v 3.924 h 9.825 l 0.01,-24.762 6.687,-6.38 0.674,0.487 C -10.458,-10.13 -5.084,-5.381 0,0" /></g><g
                transform="translate(707.4977,415.8945)"
                id="g60"><path
             id="path62"
             style="fill:#0079de;fill-opacity:1;fill-rule:nonzero;stroke:none"
             d="M 0,0 -11.31,5.231 -11.838,3.398 C -17.352,-15.718 -26.149,-32.82 -37.981,-47.43 l -0.545,-0.67 3.922,-13.139 1.954,2.169 c 3.189,3.546 6.337,7.446 9.379,11.624 v -65.169 h 12.047 v 84.518 c 4.254,8.314 7.787,17.059 10.802,26.729 z" /></g><g
                transform="translate(753.0168,403.0507)"
                id="g64"><path
             id="path66"
             style="fill:#0079de;fill-opacity:1;fill-rule:nonzero;stroke:none"
             d="M 0,0 -0.227,0.602 C -1.784,5.415 -3.791,10.37 -6.36,15.751 l -0.589,1.239 -11.808,-3.251 0.946,-1.8 C -15.746,8.012 -13.944,4.092 -12.322,0 h -37.312 v -11.673 h 83.72 V 0 Z" /></g><path
                id="path68"
                style="fill:#0079de;fill-opacity:1;fill-rule:nonzero;stroke:none"
                d="m 712.402,372.896 h 66.296 v 11.308 h -66.296 z" /><path
                id="path70"
                style="fill:#0079de;fill-opacity:1;fill-rule:nonzero;stroke:none"
                d="m 712.402,355.021 h 66.296 v 11.431 h -66.296 z" /><path
                id="path72"
                style="fill:#0079de;fill-opacity:1;fill-rule:nonzero;stroke:none"
                d="m 766.777,315.317 h -42.451 v 20.824 h 42.451 z m -54.375,-11.711 h 66.296 v 44.089 h -66.296 z" /><g
                transform="translate(197.2572,300.0859)"
                id="g74"><path
             id="path76"
             style="fill:#fb6500;fill-opacity:1;fill-rule:nonzero;stroke:none"
             d="m 0,0 c 0.061,-0.075 0.126,-0.148 0.196,-0.218 0.121,-0.121 0.251,-0.226 0.387,-0.32 0.27,-0.254 0.539,-0.512 0.803,-0.776 5.193,-5.193 8.457,-11.584 9.796,-18.283 0.023,-0.377 0.064,-0.753 0.124,-1.127 0.066,-0.412 0.154,-0.82 0.264,-1.224 0.514,-1.884 1.507,-3.663 2.986,-5.143 4.532,-4.531 11.879,-4.531 16.411,0 4.531,4.532 4.531,11.879 0,16.411 -1.598,1.597 -3.545,2.629 -5.595,3.1 -0.23,0.053 -0.461,0.098 -0.692,0.137 -0.234,0.039 -0.467,0.072 -0.702,0.096 -6.866,1.28 -13.43,4.573 -18.741,9.884 C 4.854,2.92 4.483,3.311 4.121,3.707 L 4.119,3.706 C 3.036,4.789 1.279,4.789 0.196,3.706 -0.818,2.692 -0.883,1.09 0,0" /></g><g
                transform="translate(233.9468,291.1704)"
                id="g78"><path
             id="path80"
             style="fill:#0082ef;fill-opacity:1;fill-rule:nonzero;stroke:none"
             d="m 0,0 c 0.075,0.061 0.148,0.126 0.218,0.196 0.121,0.121 0.226,0.251 0.32,0.387 0.254,0.27 0.512,0.539 0.776,0.803 5.193,5.193 11.584,8.457 18.283,9.796 0.377,0.023 0.753,0.064 1.127,0.124 0.412,0.066 0.82,0.154 1.224,0.264 1.884,0.514 3.663,1.507 5.143,2.986 4.531,4.532 4.531,11.879 0,16.411 -4.532,4.531 -11.879,4.531 -16.411,0 C 9.083,29.369 8.051,27.422 7.58,25.372 7.527,25.142 7.482,24.911 7.443,24.68 7.404,24.446 7.371,24.213 7.347,23.978 6.067,17.112 2.774,10.548 -2.537,5.237 -2.92,4.854 -3.311,4.483 -3.707,4.121 l 10e-4,-0.002 c -1.083,-1.083 -1.083,-2.84 0,-3.923 C -2.692,-0.818 -1.09,-0.883 0,0" /></g><g
                transform="translate(242.8623,327.86)"
                id="g82"><path
             id="path84"
             style="fill:#2dbc00;fill-opacity:1;fill-rule:nonzero;stroke:none"
             d="m 0,0 c -0.061,0.075 -0.126,0.148 -0.196,0.218 -0.121,0.121 -0.251,0.226 -0.387,0.32 -0.27,0.254 -0.539,0.512 -0.803,0.776 -5.193,5.193 -8.457,11.584 -9.796,18.283 -0.023,0.377 -0.064,0.753 -0.124,1.127 -0.066,0.412 -0.154,0.82 -0.264,1.224 -0.514,1.884 -1.507,3.663 -2.986,5.143 -4.532,4.531 -11.879,4.531 -16.411,0 -4.531,-4.532 -4.531,-11.879 0,-16.411 1.598,-1.597 3.545,-2.629 5.595,-3.1 0.23,-0.053 0.461,-0.098 0.692,-0.137 0.234,-0.039 0.467,-0.072 0.702,-0.096 6.866,-1.28 13.43,-4.573 18.741,-9.884 0.383,-0.383 0.754,-0.774 1.116,-1.17 l 0.002,10e-4 c 1.083,-1.083 2.84,-1.083 3.923,0 C 0.818,-2.692 0.883,-1.09 0,0" /></g><g
                transform="translate(206.1727,336.7755)"
                id="g86"><path
             id="path88"
             style="fill:#ffcc00;fill-opacity:1;fill-rule:nonzero;stroke:none"
             d="m 0,0 c -0.075,-0.061 -0.148,-0.126 -0.218,-0.196 -0.121,-0.121 -0.226,-0.251 -0.32,-0.387 -0.254,-0.27 -0.512,-0.539 -0.776,-0.803 -5.193,-5.193 -11.584,-8.457 -18.283,-9.796 -0.377,-0.023 -0.753,-0.064 -1.127,-0.124 -0.412,-0.066 -0.82,-0.154 -1.224,-0.264 -1.884,-0.514 -3.663,-1.507 -5.143,-2.986 -4.531,-4.532 -4.531,-11.879 0,-16.411 4.532,-4.531 11.879,-4.531 16.411,0 1.597,1.598 2.629,3.545 3.1,5.595 0.053,0.23 0.098,0.461 0.137,0.692 0.039,0.234 0.072,0.467 0.096,0.702 1.28,6.866 4.573,13.43 9.884,18.741 0.383,0.383 0.774,0.754 1.17,1.116 l -10e-4,0.002 c 1.083,1.083 1.083,2.84 0,3.923 C 2.692,0.818 1.09,0.883 0,0" /></g><g
                transform="translate(223.427,393.4745)"
                id="g90"><path
             id="path92"
             style="fill:#0079de;fill-opacity:1;fill-rule:nonzero;stroke:none"
             d="m 0,0 c -3.227,6.632 -7.564,12.788 -12.889,18.298 -13.456,13.917 -32.295,22.881 -53.045,25.24 -3.725,0.423 -7.417,0.637 -10.974,0.637 -3.39,0 -6.925,-0.197 -10.507,-0.587 -20.843,-2.266 -39.786,-11.183 -53.341,-25.109 -5.35,-5.497 -9.709,-11.639 -12.959,-18.253 -4.409,-8.976 -6.644,-18.504 -6.644,-28.319 0,-12.637 3.845,-25.097 11.12,-36.035 4.114,-6.186 11.149,-14.181 17.171,-19.08 v 0 l -3.335,-13.795 -0.961,-3.885 c -0.169,-0.382 -0.3,-0.782 -0.392,-1.199 -0.057,-0.254 -0.074,-0.521 -0.099,-0.786 -0.019,-0.201 -0.061,-0.395 -0.061,-0.602 0,-3.547 2.875,-6.422 6.423,-6.422 1.159,0 2.232,0.331 3.171,0.868 0.029,0.017 0.061,0.032 0.089,0.049 0.138,0.081 0.278,0.153 0.409,0.243 l 23.82,11.956 c 5.127,-1.471 10.214,-2.412 15.578,-3.002 3.486,-0.384 7.025,-0.578 10.518,-0.578 3.562,0 7.254,0.215 10.974,0.638 7.315,0.831 14.351,2.517 21.03,4.914 -0.722,0.24 -1.431,0.553 -2.117,0.946 -4.086,2.337 -6.202,6.783 -5.782,11.183 -4.773,-1.516 -9.757,-2.603 -14.91,-3.188 -3.126,-0.356 -6.221,-0.536 -9.195,-0.536 -2.923,0 -5.885,0.163 -8.803,0.484 -0.609,0.067 -1.215,0.16 -1.822,0.241 -4.009,0.534 -7.972,1.351 -11.8,2.473 -0.78,0.249 -1.606,0.375 -2.453,0.375 -1.32,0 -2.601,-0.349 -3.9,-1.023 -0.168,-0.087 -0.335,-0.159 -0.504,-0.258 l -15.284,-9.007 -0.016,-0.009 c -0.317,-0.185 -0.496,-0.254 -0.66,-0.254 -0.537,0 -0.973,0.454 -0.973,1.012 l 0.565,2.283 c 0.158,0.602 0.381,1.45 0.651,2.481 0.668,2.544 1.581,6.024 2.259,8.607 0.147,0.528 0.297,1.162 0.297,1.874 0,1.967 -0.941,3.826 -2.509,4.968 -0.798,0.59 -1.595,1.209 -2.433,1.891 -1.283,1.044 -2.51,2.132 -3.691,3.252 -3.318,3.147 -6.231,6.582 -8.678,10.262 -5.762,8.662 -8.807,18.491 -8.807,28.426 0,7.71 1.763,15.208 5.239,22.284 2.597,5.286 6.095,10.208 10.398,14.63 11.142,11.448 26.811,18.788 44.119,20.67 3.013,0.328 5.975,0.494 8.805,0.494 2.971,0 6.065,-0.18 9.195,-0.536 17.228,-1.959 32.806,-9.336 43.865,-20.774 4.283,-4.431 7.762,-9.364 10.341,-14.663 3.42,-7.031 5.155,-14.468 5.155,-22.105 0,-0.794 -0.05,-1.585 -0.089,-2.377 4.469,2.735 10.375,2.198 14.243,-1.67 0.196,-0.195 0.36,-0.409 0.538,-0.615 0.128,1.627 0.199,3.259 0.199,4.895 C 6.539,-18.369 4.339,-8.917 0,0" /></g></g></g></g></svg>
        <p>请在手机企业微信中打开该链接</p>
    </div>
    <div style="opacity: 0;">
        <button class="btn btn_primary debug-button" data-type="shareWechatMessage">点我分享到微信去</button>
        <button class="debug-button" id="clearToken">清除 Access-Token ls</button>
        <button class="debug-button" id="clearAll">清除全部缓存</button>
    </div>
    <div class="share-loading-box">
        <div class="loading">
            <div class="left"></div>
            <div class="right"></div>
        </div>
    </div>
    <div style="opacity: 0;">
        <h1>-----log------</h1>
        <div class="log-box"></div>
    </div>
<script>

    /**
     *  清除所有缓存
     */
    let clear_n = 0;
    function clearLS () {
        $('#clearToken').on('click', function () {
          clear_n++;
          if (clear_n > 5) {
            localStorage.removeItem('Access-Token');
          }
        })
        $('#clearAll').on('click', function () {
          clear_n++;
          if (clear_n>10) {
            localStorage.clear()
          }
        })
    }

    /**
     * 获取 url 中传递过来的所有参数
     */
    const getFormatUrl = function(url) {
      let queryString = url.slice(url.indexOf('?')+1)
      let tempArr = queryString.split('&')
      let obj = {}
      tempArr.forEach(item => {
        let arr = item.split('=')
        obj[arr[0]] = arr[1]
      });
      return obj
    }

    function getQueryStr (name) {
        let result = location.search.match(new RegExp("[\?\&]" + name + "=([^\&]+)", "i"));
        if (result == null || result.length < 1) {
            return "";
        }
        return result[1];
    }

    /**
     * 获取本地存储中的 token 值
     */
    const getRuntimeEnv = function() {
        const token = localStorage.getItem('access-token')
        return (token || false)
    }

    /**
     * 将 url 中的 token 或者 ls 中的 token 进行jwt的解析，获取 uid
     */
    const formatToken = function (tk) {
        log_box.append('【 解析token 】=====>', tk);
        //data.data.normal_login_token为发送Ajax获取到的token信息
        let strings = tk.split(".");//通过split()方法将token转为字符串数组
        //取strings[1]数组中的第二个字符进行解析
        let userinfo = JSON.parse(decodeURIComponent(escape(window.atob(strings[1].replace(/-/g, "+").replace(/_/g, "/")))));
        //然后可以拿到解析后的数据，可以console.log()打印下，
        log_box.append('【 解析URL中 或 ls中的 token 】====>>>', userinfo)
        //然后赋值自己需要的数据
        // var accountId = userinfo.accountId;
        return userinfo;
    }

    const DEVICE_TYPE = {
        DESKTOP: 'desktop',
        TABLET: 'tablet',
        MOBILE: 'mobile'
    }
    const PROJECT_SYSTEM = {
        CorpWeChatMobile: {
            system: 'CorpWeChatMobile',
            value: '企业微信移动端'
        },
        CorpWeChatDesktop: {
            system: 'CorpWeChatDesktop',
            value: '企业微信桌面端'
        },
        Other: {
            system: 'Other',
            value: '其他'
        },
        WebDesktop: {
            system: 'WebDesktop',
            value: '浏览器桌面端'
        }
    }
    let ACTIVE_SYSTEM = {
        WebDesktop: {
            system: false,
            value: ''
        }
    }
    /**
     * 获取当前页面运行设备环境
     * definition
     */
    function definition (type, _this) {
        log_box.append('【 definition type 】=====>', type);
        log_box.append('【 definition type 】=====>', JSON.stringify(navigator.userAgent));
        const ua = navigator.userAgent.toLowerCase()
        const mobile = (DEVICE_TYPE.MOBILE === type)
        log_box.append('【 DEVICE_TYPE.MOBILE 】=====>', DEVICE_TYPE.MOBILE);
        log_box.append('【 UA 】=====>', ua.includes('wxwork', 0));
        let o = {
            system: 'other',
            value: '其他'
        }
        if (ua.includes('wxwork', 0)) {
            o.system = 'wxwork'
            if (mobile) {
                o.value = PROJECT_SYSTEM.CorpWeChatMobile.value
                o.system = PROJECT_SYSTEM.CorpWeChatMobile.system
            } else {
                o.value = PROJECT_SYSTEM.CorpWeChatDesktop.value
                o.system = PROJECT_SYSTEM.CorpWeChatDesktop.system
            }
            ACTIVE_SYSTEM.system = true
        } else {
            if (mobile) {
                o.value = PROJECT_SYSTEM.Other.value
                o.system = PROJECT_SYSTEM.Other.system
            } else {
                o.value = PROJECT_SYSTEM.WebDesktop.value
                o.system = PROJECT_SYSTEM.WebDesktop.system
            }
        }
        o.mobile = (mobile || false)
        log_box.append('【 o detail 】=====>', JSON.stringify(o));
        return o
    }

    const log_box = document.getElementsByClassName('log-box')[0]
    log_box.append('test======', definition(navigator.userAgent))
    log_box.append(`${JSON.stringify(definition(navigator.userAgent))}`)

    /**
     * 通过 url 判断当前开发环境
     */
    const judgeEnv = function () {
        let dev = new RegExp(/article-dev/);
        if (dev.test(window.location.host)) {
            // development
            window.location.href = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx41f4e6c3cdaa38e9&redirect_uri=https%3A%2F%2Fapi.test.pbcsf.net%2Fapi%2Fv1%2Foauth%2Fcorp-wechat%2Fcms%2Fcallback&response_type=code&scope=snsapi_base&state=L2luZGV4#wechat_redirect';
        } else {
            // production
            window.location.href = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx41f4e6c3cdaa38e9&redirect_uri=https%3A%2F%2Fgateway.pbcsf.net%2Fapi%2Fv1%2Foauth%2Fcorp-wechat%2Fcms%2Fcallback&response_type=code&scope=snsapi_base&state=L2luZGV4#wechat_redirect';
        }
        log_box.append(`尚未登录。`)
    }

    // 解析token 在文章url中拼接tid 和 teacher 信息
    function formatTidTeacher () {
        log_box.append(`====> 【 解析token 在文章url中拼接tid 和 teacher 信息 】`)
        const formatUrl = getFormatUrl(window.location.href);
        log_box.append(`====> 【 格式化后的url参数 】`, JSON.stringify(formatUrl))
        if (getQueryStr('access_token')) {
            localStorage.setItem('access_token', getQueryStr('access_token'));
        }
        const userInfoData = formatToken(localStorage.getItem('access_token'));

        log_box.append(`====> 【 解析token，获取uid 】`, JSON.stringify(userInfoData));
        const FormatString = 'tid=' + userInfoData.sub + '&teacher=' + userInfoData.nickname;
        log_box.append(`====> 【 已生成拼接信息 】`, JSON.stringify(FormatString));
        //  重定向,返回文章分享链接地址
        if (localStorage.getItem('cms_url')) {
            const redirect = decodeURIComponent(localStorage.getItem('cms_url'))
            const regHtml = new RegExp(/html\?/g)
            if (regHtml.test(redirect)) {
                window.location.href = (redirect + '&' + FormatString)
            } else {
                window.location.href = (redirect + '?' + FormatString)
            }
        }
    }

    // 判断是否存在token
    function checkToken () {
        log_box.append(`====> 【 查看token是否已存在 】`)
        //  是否存在token
        if (localStorage.getItem('access_token')) {
            formatTidTeacher()
        } else {
            const formatUrl = getFormatUrl(window.location.href);
            if (formatUrl['access_token']) {
                formatTidTeacher()
            } else {
                //  企业微信授权
                judgeEnv();
            }
        }
    }


    /**
     * @returns {boolean}
     */
    function isMobileWXWork () {
        let ua = navigator.userAgent.toLowerCase();
        return ua.indexOf('mobile') !== -1 && ua.indexOf('wxwork') !== -1;
    }

    $(document).ready(function(){
        // 判断当前 页面打开设备 是否为企业微信

        log_box.append(`====> 【 definition(navigator.userAgent) 】=====>。`, definition(navigator.userAgent))
        // const _system_ = definition(navigator.userAgent);
        // 企业微信环境
        if (isMobileWXWork()) {
        // if ((_system_.system === PROJECT_SYSTEM.CorpWeChatMobile.system)) {
            //  解析当前 回调回来的 url 参数
            const formatUrl = getFormatUrl(window.location.href);
            log_box.append(`====> 【 解析url 】`, JSON.stringify(formatUrl));
            if (getQueryStr('url')) {
                localStorage.setItem('cms_url', encodeURIComponent(getQueryStr('url')));
                //  是否存在token
                checkToken()
            } else {
                // 是否存在 文章链接
                if (localStorage.getItem('cms_url')) {
                    //  是否存在token
                    checkToken()
                } else {
                    $('.body-box').show();
                    $('.body-box p').text('提示：请检查链接！');
                }
            }
        } else {
            $('.body-box').show();
        }
        let cms_n = 0;
        $('.body-box').on('click', function () {
            cms_n ++;
            if (cms_n > 15) {
                $('.body-box').hide();
            }
        });
        clearLS();
    });
</script>

</body>
</html>
